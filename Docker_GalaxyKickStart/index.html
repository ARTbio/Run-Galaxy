<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Install a Galaxy server with Docker - Run-Galaxy</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Install a Galaxy server with Docker";
    var mkdocs_page_input_path = "Docker_GalaxyKickStart.md";
    var mkdocs_page_url = "/Docker_GalaxyKickStart/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Run-Galaxy</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Prerequites</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../spin_off_VM/">Spin off a Virtual Machine</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../bare-galaxy/">Install a minimal standalone galaxy server</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../GalaxyKickStart/">Install a Galaxy server with Ansible and GalaxyKickStart</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Install a Galaxy server with Docker</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#installation-of-a-galaxy-server-with-docker">Installation of a Galaxy server with Docker</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#what-is-docker">What is Docker ?</a></li>
        
            <li><a class="toctree-l3" href="#galaxykickstart-docker-container">GalaxyKickStart Docker Container</a></li>
        
            <li><a class="toctree-l3" href="#deployment">Deployment</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Run_workflow/">After deployment use case</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../GCE_TP_Galaxy/">Annex 1: Run your personal TP Galaxy server</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Galaxy_architecture/">Annex 2: Galaxy software architecture</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Run-Galaxy</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Install a Galaxy server with Docker</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="installation-of-a-galaxy-server-with-docker">Installation of a Galaxy server with Docker</h2>
<h3 id="what-is-docker">What is Docker ?</h3>
<p><img alt="Docker" src="../images/docker.png" /></p>
<h4 id="virtual-machines">Virtual machines</h4>
<p>Virtual machines (VMs) are an abstraction of physical hardware turning one server into
many servers. The hypervisor allows multiple VMs to run on a single machine.
Each VM includes a full copy of an operating system, one or more apps, necessary binaries
and libraries - taking up tens of GBs. VMs can also be slow to boot.</p>
<h4 id="containers">Containers</h4>
<p>Containers are an abstraction at the app layer that packages code and dependencies
together. Multiple containers can run on the same machine and share the OS kernel with
other containers, each running as isolated processes in user space. Containers take up
less space than VMs (container images are typically tens of MBs in size), and start
almost instantly.</p>
<h3 id="galaxykickstart-docker-container">GalaxyKickStart Docker <strong>Container</strong></h3>
<p>Instead of using the GalaxyKickStart playbook in a VM, the playbook can be used to build
a Docker container image that will be an almost exact mirror of the GalaxyKickStart VM
you have just built.</p>
<p>You are not going to do that today (although you should be able to do it by reading the instructions).</p>
<p>Instead, you are going to</p>
<ul>
<li>Install the <code>docker</code> system</li>
<li>pull the GalaxyKickStart docker container that is deposited in the <a href="https://hub.docker.com/u/artbio/"><code>Docker Hub</code></a></li>
<li>run this docker container and connect to the deployed GalaxyKickStart server instance</li>
</ul>
<h3 id="deployment">Deployment</h3>
<ul>
<li>start a GCE VM <code>2 procs, 7.5Gb RAM, Ubuntu 14.04, 100 Go disk, http enabled</code></li>
<li>connect to you VM using the Google ssh console</li>
<li>start an interactive session as root using the command <code>sudo -i</code></li>
<li>download the script <code>install_docker.sh</code> using the command <code>wget https://raw.githubusercontent.com/ARTbio/Run-Galaxy/master/deployment_scripts/install_docker.sh</code></li>
<li>run the script using the command <code>sh install_docker.sh</code></li>
<li>
<p>Connect to your ansible-deployed "GalaxyKickStart" instance:</p>
<p>Just click on the url displayed in your Google Cloud Engine Console.</p>
</li>
</ul>
<h4 id="the-install_dockersh-script-explained">The install_docker.sh script explained</h4>
<p>NB: in the following code, numbers in line heads should be removed to run the script.</p>
<pre><code>1  #!/usr/bin/env bash
2  set -e
3  apt-key adv --recv-keys --keyserver hkp://p80.pool.sks-keyservers.net:80 58118E89F3A912897C070ADBF76221572C52609D
4  add-apt-repository &quot;deb https://apt.dockerproject.org/repo ubuntu-trusty main&quot;
5  apt-get update -y
6  apt-get -y install docker-engine
7  echo &quot;Docker system is installed\n&quot;
8  echo &quot;Now pulling the galaxykickstart docker image from DockerHub\n&quot;
9  docker pull artbio/galaxykickstart
10 echo &quot;Running galaxykickstart docker container\n&quot;
11 export DOCKER_INSTANCE=`docker run -d -p 80:80 -p 21:21 -p 8800:8800 \
12           --privileged=true \
13           -e GALAXY_CONFIG_ALLOW_USER_DATASET_PURGE=True \
14           -e GALAXY_CONFIG_ALLOW_LIBRARY_PATH_PASTE=True \
15           -e GALAXY_CONFIG_ENABLE_USER_DELETION=True \
16           -e GALAXY_CONFIG_ENABLE_BETA_WORKFLOW_MODULES=True \
17           -v /tmp/:/tmp/ \
18           -v /export/:/export \
19           artbio/galaxykickstart`
20 echo &quot;The galaxykickstart docker container is up and running\n&quot;
21 echo &quot;Please wait for a few secondes and interrupt logging when all services are launched\n&quot;
22 echo &quot;Ctrl-C to stop logging\n\n&quot;
23 docker logs -f $DOCKER_INSTANCE
</code></pre>

<ol>
<li>The shebang line. Says that it is a script code and that the interpreter to execute the
code is bash and can be found in the /usr/bin/env environment</li>
<li>set -e says to the bash interpreter to exit the run at first error (to avoid catastrophes)</li>
<li>installs an authentication key to interact with the repository <code>apt.dockerproject.org</code> that
will be declared in the next code line</li>
<li>Adds the repository <code>https://apt.dockerproject.org/repo</code> to the system settings</li>
<li>Updates the system settings so that the added repo is registered for the apt-get program</li>
<li>Installs the Docker system as depicted in the figure above !</li>
<li>reports to the terminal user</li>
<li>reports to the terminal user</li>
<li>Pulls (Downloads) the Docker Image <code>artbio/galaxykickstart</code> from
the <a href="https://hub.docker.com/r/artbio/galaxykickstart/">DockerHub repository</a></li>
<li>reports to the terminal user</li>
<li>
<p>Lines 11 to 19 are actually a single command to run an instance of the galaxykickstart
docker image. Note the <code>\</code> at ends of lines 11 to 18: this character <code>\</code> specify that the
code line is continued without line break for the bash interpreter.</p>
<p>The line 11 starts with an <code>export DOCKER_INSTANCE=</code> instruction. This means that the result
of the command between ` after the sign <code>=</code> will be put in the environmental variable
<code>DOCKER_INSTANCE</code>, available system-wide.</p>
<p>Now, the docker command (between `) itself:</p>
<p>Still in line 11, we have <code>docker run -d -p 80:80 -p 21:21 -p 8800:8800</code>.</p>
<p>This means that a container will be run as a deamon (<code>-d</code> option) and that the internal
TCP/IP ports 80 (web interface) and 21 (ftp interface) of the docker instance will be mapped
to the ports 80 and 21 of your machin (The VM in this case). Note that in the syntax <code>-p 80:80</code>,
the host port is specified to the left of the <code>:</code> and the docker port is specified to the right
of the <code>:</code>.</p>
</li>
<li>
<p>docker command continued: here we specify that the docker container acquires the root privileges</p>
</li>
<li>
<p>docker command continued: <code>-e GALAXY_CONFIG_ALLOW_USER_DATASET_PURGE=True</code>.</p>
<p>The -e option specifies an environmental variable <code>GALAXY_CONFIG_ALLOW_USER_DATASET_PURGE</code>
passed (<code>e</code>xported) to the docker container with the value <code>True</code>
<code>galaxy_manage_trackster: true</code> with the string <code>galaxy_manage_trackster: false</code>
in the ansible configuration file <code>groups/all</code>.</p>
</li>
<li>
<p>The environmental variable <code>GALAXY_CONFIG_ALLOW_LIBRARY_PATH_PASTE</code> is exported to
the docker container with the value <code>True</code></p>
</li>
<li>The environmental variable <code>GALAXY_CONFIG_ENABLE_USER_DELETION</code> is exported to
the docker container with the value <code>True</code></li>
<li>
<p>The environmental variable <code>GALAXY_CONFIG_ENABLE_BETA_WORKFLOW_MODULES</code> is exported to
the docker container with the value <code>True</code></p>
<p>Note that all these exports in the docker command correspond to advanced boiling/tuning of the docker container.
You are not obliged to understand the details to get the container properly running.
17. Now the -v is important, better to understand it !</p>
<p>-v stands for "volume". the <code>-v</code> option says to export the /tmp directory of the docker container
to the /tmp directory of the host.
18. we also export the /export directory of the container (any docker container has or
should have by default an /export directory) to an /export directory of the host (your VM here).</p>
<p>Note that if the /export directory does not exists at docker run runtime, it will be created.</p>
<p>So it is important to understand the -v magics: every directory specified by the -v option will be shared
between the docker container filesystem and the host filesystem. It is a mapping operation, so that
the same directory is accessible either from inside the docker container or from inside the host.</p>
<p>Now, if you stop and remove the docker container, all exported directory will persist in the host.
If you don't do that, all operations performed with a container are lost when you stop this container !</p>
</li>
<li>
<p>This is the end of the docker run command. The docker image to be instantiated is specified.</p>
</li>
<li>reports to the terminal user</li>
<li>reports to the terminal user</li>
<li>reports to the terminal user</li>
<li>Now that the docker container is launched, you can access its logs with the command
<code>docker logs -f</code> (-f means continuous logging until keyboard interruption) followed by the
identification number of the docker container. We have put this ID in the variable <code>DOCKER_INSTANCE</code>
and we access to the content of this variable by prefixing the variable with a <code>$</code>:
<code>docker logs -f $DOCKER_INSTANCE</code></li>
</ol>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Run_workflow/" class="btn btn-neutral float-right" title="After deployment use case">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../GalaxyKickStart/" class="btn btn-neutral" title="Install a Galaxy server with Ansible and GalaxyKickStart"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../GalaxyKickStart/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../Run_workflow/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
